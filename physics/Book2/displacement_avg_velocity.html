
<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ç†æ¨¡æ“¬ï¼šè·¯ç¨‹èˆ‡ä½ç§» (Distance vs Displacement)</title>
    <style>
        :root {
            --primary-bg: #f0f2f5;
            --panel-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-sub: #666666;
            --blue-path: #2980b9; /* è·¯ç¨‹é¡è‰² */
            --red-vect: #c0392b;  /* ä½ç§»é¡è‰² */
            --accent: #27ae60;    /* æ“ä½œæç¤º */
            --grid-color: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* æ¨™é¡Œå€åŸŸ */
        header {
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        h1 { margin: 0; color: var(--text-main); font-size: 1.8rem; }
        .subtitle { color: var(--text-sub); font-size: 1rem; margin-top: 5px; }

        /* ä¸»ä½ˆå±€ï¼šå·¦ç•«å¸ƒï¼Œå³æ•¸æ“š */
        .main-container {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0; /* é˜²æ­¢æº¢å‡º */
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }

        /* ç•«å¸ƒå®¹å™¨ */
        .canvas-wrapper {
            flex: 3;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        /* ç•«å¸ƒä¸Šçš„æµ®å‹•æç¤º */
        .overlay-hint {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 5px solid var(--accent);
            font-weight: bold;
            color: var(--text-main);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            pointer-events: none;
            transition: all 0.3s ease;
        }

        /* ç¶²æ ¼æ¯”ä¾‹å°ºæ¨™ç¤º */
        .grid-legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #555;
            pointer-events: none;
        }

        /* å³å´æ§åˆ¶é¢æ¿ */
        .control-panel {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        /* æ•¸æ“šå¡ç‰‡ */
        .card {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1rem;
        }
        .data-value {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* é¡è‰²æ¨™è¨˜ */
        .c-blue { color: var(--blue-path); }
        .c-red { color: var(--red-vect); }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: auto; 
        }
        .btn-row {
            display: flex;
            gap: 10px;
        }
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:active { transform: scale(0.98); }
        .btn-reset { background: #95a5a6; color: white; }
        .btn-explain { background: #34495e; color: white; }
        
        /* é–‹å§‹æŒ‰éˆ•ç‰¹æ•ˆ */
        #btnStart {
            background: var(--accent);
            color: white;
            font-size: 1.2rem;
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.3);
            display: block; /* æ°¸é é¡¯ç¤º */
        }
        /* ç¦ç”¨ç‹€æ…‹ */
        #btnStart:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }
        /* æ¿€æ´»å¾Œçš„è„ˆè¡å‹•ç•« - æ”¹ç‚º box-shadow é¿å…æ’é–‹ç‰ˆé¢ */
        #btnStart:not(:disabled) {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
        }

        /* å½ˆå‡ºè¦–çª— (Modal) */
        .modal-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .concept-section {
            background: #f8f9fa;
            border-left: 4px solid #ccc;
            padding: 15px;
            margin: 15px 0;
        }
        .note-highlight {
            background-color: #e8f5e9;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            color: #2e7d32;
        }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .canvas-wrapper { height: 400px; flex: none; }
            .control-panel { flex: none; }
        }
    </style>
</head>
<body>

<header>
    <h1>ç‰©ç†é‹å‹•æ¨¡æ“¬å™¨</h1>
    <div class="subtitle">Displacement vs Average Velocity Simulation</div>
</header>

<div class="main-container">
    <!-- å·¦å´ç•«å¸ƒ -->
    <div class="canvas-wrapper" id="canvasBox">
        <canvas id="simCanvas"></canvas>
        <div class="overlay-hint" id="statusText">è«‹åœ¨ç•«å¸ƒä¸Šé»æ“Šã€Œèµ·å§‹é»ã€</div>
        <div class="grid-legend">ğŸ“ 1 æ ¼ = 1 å…¬å°º (m)</div>
    </div>

    <!-- å³å´æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <!-- æ•¸æ“šé¡¯ç¤º -->
        <div class="card">
            <div class="card-title">é æ¸¬èˆ‡å¯¦æ™‚æ•¸æ“š (t = 5.0s)</div>
            
            <!-- è·¯ç¨‹æ•¸æ“š -->
            <div class="data-row c-blue">
                <span>ç¸½è·¯ç¨‹ (Distance)</span>
                <span class="data-value" id="valDist">0.0 m</span>
            </div>
            <div class="data-row c-blue">
                <span>å¹³å‡é€Ÿç‡ (Avg Speed)</span>
                <span class="data-value" id="valSpeed">0.00 m/s</span>
            </div>
            
            <hr style="border: 0; border-top: 1px dashed #ddd; margin: 15px 0;">

            <!-- ä½ç§»æ•¸æ“š -->
            <div class="data-row c-red">
                <span>ä½ç§» (Displacement)</span>
                <span class="data-value" id="valDisp">0.0 m</span>
            </div>
            <div class="data-row c-red">
                <span>å¹³å‡é€Ÿåº¦ (Avg Velocity)</span>
                <span class="data-value" id="valVel">0.00 m/s</span>
            </div>
        </div>

        <!-- æ•™å­¸ç­†è¨˜ -->
        <div class="card" style="flex:1; background-color: #fffcf5; border: 1px solid #ffeebb; display: flex; flex-direction: column;">
            <div class="card-title">ğŸ‘¨â€ğŸ« è€å¸«æ•™å­¸ç­†è¨˜</div>
            <div style="flex:1; overflow-y: auto; font-size: 0.95rem; line-height: 1.6; color: #444;">
                <p><strong>1. è§€å¿µæ ¸å¿ƒï¼š</strong><br>
                ä½ç§»åªåœ¨ä¹<span class="note-highlight">èµ·é»</span>èˆ‡<span class="note-highlight">çµ‚é»</span>ï¼Œå®Œå…¨ä¸ç†æœƒéç¨‹ä¸­çš„ç¹è·¯ã€‚</p>
                
                <p><strong>2. æ·±å…¥æ€è€ƒï¼š</strong><br>
                â“ <strong>å¦‚æœå­¸ç”Ÿç•«äº†ä¸€å€‹å°é–‰åœ–å½¢ï¼ˆçµ‚é»å›åˆ°èµ·é»ï¼‰ï¼š</strong><br>
                ä½ç§»å°‡è®Šç‚º 0 mï¼Œå› æ­¤å¹³å‡é€Ÿåº¦ä¹Ÿæ˜¯ 0 m/sï¼Œå³ä¾¿ä»–è·‘å¾—å¾ˆç´¯ï¼ˆè·¯ç¨‹å¾ˆå¤§ï¼‰ã€‚</p>

                <p>â“ <strong>é—œæ–¼æ–¹å‘æ€§ï¼š</strong><br>
                å¹³å‡é€Ÿåº¦æ˜¯ä¸€å€‹å‘é‡ï¼ˆVectorï¼‰ï¼Œå®ƒçš„æ–¹å‘æ°¸é æŒ‡å‘ä½ç§»çš„æ–¹å‘ï¼ˆç´…è™›ç·šï¼‰ã€‚æ³¨æ„çœ‹è—çƒåœ¨è½‰å½æ™‚ï¼Œé›–ç„¶é€Ÿç‡ä¸è®Šï¼Œä½†é‹å‹•æ–¹å‘æ”¹è®Šäº†ï¼Œé€™æ„å‘³è‘—å®ƒæœ‰åŠ é€Ÿåº¦ã€‚</p>
                
                <p style="margin-bottom:0; color:#d35400;"><strong>ğŸ’¡ æ•™å­¸å»ºè­°ï¼š</strong><br>
                è«‹å­¸ç”Ÿå…ˆç•«ä¸€æ¢ç›´ç·šï¼Œè§€å¯Ÿå…©è€…æ•¸æ“šç›¸åŒã€‚å†ç•«æŠ˜ç·šï¼Œè§€å¯Ÿå·®ç•°ã€‚é€™èƒ½æœ‰æ•ˆå»ºç«‹ã€Œç›´ç·šé‹å‹• vs æ›²ç·šé‹å‹•ã€çš„æ¦‚å¿µå·®ç•°ã€‚</p>
            </div>
        </div>

        <!-- æŒ‰éˆ• -->
        <div class="btn-group">
            <button id="btnStart" onclick="runSimulation()" disabled>â–¶ é–‹å§‹æ¨¡æ“¬ (Start)</button>
            <div class="btn-row">
                <button class="btn-reset" onclick="resetSim()">é‡ç½® (Reset)</button>
                <button class="btn-explain" onclick="toggleModal(true)">åŸç†è©³è§£</button>
            </div>
        </div>
    </div>
</div>

<!-- å½ˆå‡ºæ•™å­¸è¦–çª— (Modal) -->
<div class="modal-backdrop" id="conceptModal" onclick="if(event.target === this) toggleModal(false)">
    <div class="modal-content">
        <span class="close-btn" onclick="toggleModal(false)">&times;</span>
        <h2 style="margin-top:0; color:var(--text-main)">é—œéµæ¦‚å¿µè§£æ</h2>
        
        <p>å„ä½åŒå­¸ï¼Œåœ¨é€™å€‹æ¨¡æ“¬ä¸­ï¼Œæˆ‘å€‘å¯ä»¥çœ‹åˆ°åŒä¸€æ®µæ™‚é–“ (5ç§’) å…§çš„å…©ç¨®ä¸åŒè§€é»ï¼š</p>

        <div class="concept-section" style="border-color: var(--blue-path);">
            <h3 style="margin:0 0 10px 0; color:var(--blue-path)">1. è·¯ç¨‹èˆ‡é€Ÿç‡ (Scalar - æ¨™é‡)</h3>
            <p style="margin:0;">
                <strong>è·¯ç¨‹ (Distance)</strong> æ˜¯ç‰©é«”å¯¦éš›èµ°éçš„è»Œè·¡ç¸½é•·ã€‚<br>
                <strong>å¹³å‡é€Ÿç‡</strong> = ç¸½è·¯ç¨‹ Ã· æ™‚é–“ã€‚<br>
                <em>é€™åªé—œå¿ƒã€Œä½ èµ°äº†å¤šå°‘æ­¥ã€ä»¥åŠã€Œè·‘å¾—æœ‰å¤šå¿«ã€ã€‚</em>
            </p>
        </div>

        <div class="concept-section" style="border-color: var(--red-vect);">
            <h3 style="margin:0 0 10px 0; color:var(--red-vect)">2. ä½ç§»èˆ‡é€Ÿåº¦ (Vector - çŸ¢é‡)</h3>
            <p style="margin:0;">
                <strong>ä½ç§» (Displacement)</strong> æ˜¯èµ·é»æŒ‡å‘çµ‚é»çš„ç›´ç·šè·é›¢èˆ‡æ–¹å‘ã€‚<br>
                <strong>å¹³å‡é€Ÿåº¦</strong> = ä½ç§» Ã· æ™‚é–“ã€‚<br>
                <em>é€™åªé—œå¿ƒã€Œä½ æœ€çµ‚ä½ç½®æ”¹è®Šäº†å¤šå°‘ã€ä»¥åŠã€Œå¾€å“ªå€‹æ–¹å‘è®Šã€ã€‚</em>
            </p>
        </div>

        <div style="background:#eee; padding:15px; border-radius:8px;">
            <strong>ğŸ§  é€²éšæ€è€ƒé¡Œï¼š</strong><br>
            <ul style="margin:10px 0 0 20px; padding:0;">
                <li>å¦‚æœè—çƒåœ¨æ¯ä¸€æ®µç·šä¸Šçš„ã€Œé€Ÿç‡ã€éƒ½æ˜¯æ†å®šçš„ï¼Œé‚£å®ƒåœ¨è½‰å½çš„é‚£ä¸€ç¬é–“ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿ(æç¤ºï¼šé€Ÿåº¦çš„æ–¹å‘æ”¹è®Šäº†)</li>
                <li>é€™å°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘éœ€è¦å€åˆ†ã€Œå¹³å‡é€Ÿåº¦ã€å’Œã€Œç¬æ™‚é€Ÿåº¦ã€ã€‚</li>
            </ul>
        </div>
        <br>
        <button onclick="toggleModal(false)" style="width:100%; background:var(--accent); color:white;">æˆ‘æ˜ç™½äº†</button>
    </div>
</div>

<script>
    // --- ç³»çµ±è®Šæ•¸ ---
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvasBox');
    
    // ç‹€æ…‹
    let points = [];
    const MAX_POINTS = 4; // èµ·é» + 3å€‹è½‰æŠ˜é» = 3æ¢ç·š
    let isAnimating = false;
    let startTime = 0;
    const DURATION = 5000; // 5ç§’
    let ghostPoint = null; // é¼ æ¨™æ‡¸åœæ™‚çš„å¸é™„é è¦½é»
    
    // æ¯”ä¾‹å°ºè¨­å®šï¼šå›ºå®š 50px = 1 å…¬å°º
    const GRID_SIZE = 50; 
    const scaleRatio = 1 / GRID_SIZE; // ç±³/åƒç´ 

    // UI ç¶å®š
    const ui = {
        hint: document.getElementById('statusText'),
        dist: document.getElementById('valDist'),
        disp: document.getElementById('valDisp'),
        speed: document.getElementById('valSpeed'),
        vel: document.getElementById('valVel'),
        btnStart: document.getElementById('btnStart')
    };

    // --- åˆå§‹åŒ–èˆ‡éŸ¿æ‡‰å¼ ---
    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        if(!isAnimating) drawStatic();
    }
    window.addEventListener('resize', resize);
    
    // åˆå§‹åŸ·è¡Œä¸€æ¬¡
    setTimeout(resize, 100); 
    // è‡ªå‹•å½ˆå‡ºåŸç†è¦–çª—
    setTimeout(() => toggleModal(true), 800);

    // --- äº¤äº’é‚è¼¯ (æ»‘é¼ ç§»å‹• - å¸é™„é è¦½) ---
    canvas.addEventListener('mousemove', (e) => {
        if (isAnimating || points.length >= MAX_POINTS) {
            if(ghostPoint) {
                ghostPoint = null;
                drawStatic();
            }
            return;
        }

        const rect = canvas.getBoundingClientRect();
        const rawX = e.clientX - rect.left;
        const rawY = e.clientY - rect.top;

        // è¨ˆç®—å¸é™„å¾Œçš„åæ¨™
        const snapX = Math.round(rawX / GRID_SIZE) * GRID_SIZE;
        const snapY = Math.round(rawY / GRID_SIZE) * GRID_SIZE;

        ghostPoint = { x: snapX, y: snapY };
        drawStatic();
    });

    canvas.addEventListener('mouseleave', () => {
        ghostPoint = null;
        if (!isAnimating) drawStatic();
    });

    // --- äº¤äº’é‚è¼¯ (é»æ“Š - æ”¾ç½®é») ---
    canvas.addEventListener('mousedown', (e) => {
        if (isAnimating || points.length >= MAX_POINTS) return;

        const rect = canvas.getBoundingClientRect();
        const rawX = e.clientX - rect.left;
        const rawY = e.clientY - rect.top;

        // æ ¸å¿ƒé‚è¼¯ï¼šå¸é™„åˆ°æœ€è¿‘çš„ç¶²æ ¼é»
        const snapX = Math.round(rawX / GRID_SIZE) * GRID_SIZE;
        const snapY = Math.round(rawY / GRID_SIZE) * GRID_SIZE;

        points.push({
            x: snapX,
            y: snapY
        });

        updateUIState();
        ghostPoint = null; // é»æ“Šå¾Œæš«æ™‚éš±è—é è¦½é»
        drawStatic();
    });

    function updateUIState() {
        const count = points.length;
        
        // æç¤ºæ–‡å­—æ›´æ–°
        if (count === 0) {
            ui.hint.innerText = "è«‹åœ¨ç•«å¸ƒä¸Šé»æ“Šã€Œèµ·å§‹é»ã€";
        } else if (count < MAX_POINTS) {
            ui.hint.innerText = `é»æ“Šç•«å‡ºç¬¬ ${count} æ¢ç·š (é‚„å¯ä»¥ç•« ${MAX_POINTS - count} æ¢)`;
        } else {
            ui.hint.innerText = "ç¹ªè£½å®Œæˆï¼æŒ‰ã€Œé–‹å§‹æ¨¡æ“¬ã€è§€å¯Ÿé‹å‹•";
        }

        // æŒ‰éˆ•ç‹€æ…‹ï¼šåªè¦æœ‰ä¸€æ¢ç·š (2å€‹é») å°±å¯ä»¥é–‹å§‹
        if (count >= 2) {
            ui.btnStart.disabled = false;
            // å³æ™‚è¨ˆç®—ä¸¦é¡¯ç¤ºæ•¸æ“š
            calculateStats();
        } else {
            ui.btnStart.disabled = true;
        }
    }

    // æŒ‰ä¸‹é–‹å§‹æŒ‰éˆ•è§¸ç™¼
    function runSimulation() {
        if (points.length < 2) return;
        ui.btnStart.disabled = true; // æ¨¡æ“¬ä¸­ç¦æ­¢é‡è¤‡æŒ‰
        ui.hint.innerText = "æ¨¡æ“¬é€²è¡Œä¸­... (5ç§’æ†å®šé‹å‹•)";
        ghostPoint = null; // ç¢ºä¿å‹•ç•«ä¸­æ²’æœ‰é¬¼å½±é»
        startAnimation();
    }

    // --- ç¹ªåœ–é‚è¼¯ ---
    
    // ç•«èƒŒæ™¯ç¶²æ ¼ (å›ºå®šå°ºå¯¸)
    function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        
        // ç¹ªè£½å‚ç›´ç·š
        for (let x = 0; x < canvas.width; x += GRID_SIZE) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        // ç¹ªè£½æ°´å¹³ç·š
        for (let y = 0; y < canvas.height; y += GRID_SIZE) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }
    }

    // ç•«éœæ…‹è·¯å¾‘ (å«é è¦½é»)
    function drawStatic() {
        drawGrid();
        
        // ç•«å·²ç¢ºå®šçš„è·¯å¾‘
        if (points.length > 0) {
            // ç·šæ®µ (è—è‰²)
            if (points.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = '#2980b9';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.stroke();
            }

            // å¯¦å¿ƒé»
            points.forEach((p, i) => {
                ctx.beginPath();
                ctx.fillStyle = i === 0 ? '#27ae60' : '#2c3e50';
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fill();
                
                // æ–‡å­—æ¨™ç±¤
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                let label = "";
                if (i === 0) label = "èµ·å§‹é»";
                else if (i === points.length - 1 && points.length > 1) label = "End";
                
                if (label) ctx.fillText(label, p.x + 10, p.y - 10);
            });
        }

        // ç•«å¸é™„é è¦½é» (Ghost Point)
        if (ghostPoint && !isAnimating && points.length < MAX_POINTS) {
            ctx.beginPath();
            ctx.fillStyle = 'rgba(39, 174, 96, 0.4)'; // åŠé€æ˜ç¶ è‰²
            ctx.arc(ghostPoint.x, ghostPoint.y, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#27ae60';
            ctx.lineWidth = 1;
            ctx.stroke();
            
            // å¦‚æœæ˜¯ç•«ç·šä¸­ï¼Œé¡¯ç¤ºä¸€æ¢é è¦½ç·š
            if (points.length > 0) {
                const lastP = points[points.length-1];
                ctx.beginPath();
                ctx.strokeStyle = 'rgba(41, 128, 185, 0.4)'; // åŠé€æ˜è—ç·š
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(lastP.x, lastP.y);
                ctx.lineTo(ghostPoint.x, ghostPoint.y);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }
    }

    // --- å‹•ç•«æ ¸å¿ƒ ---
    function startAnimation() {
        isAnimating = true;
        startTime = Date.now();
        calculateStats(); // ç¢ºä¿æ•¸æ“šæœ€æ–°
        requestAnimationFrame(loop);
    }

    function calculateStats() {
        // è¨ˆç®—ç¸½è·¯ç¨‹ (Pixels)
        let totalDistPx = 0;
        for(let i=0; i<points.length-1; i++) {
            totalDistPx += Math.hypot(points[i+1].x - points[i].x, points[i+1].y - points[i].y);
        }

        // è¨ˆç®—ä½ç§» (Pixels)
        let dispPx = Math.hypot(points[points.length-1].x - points[0].x, points[points.length-1].y - points[0].y);

        // è½‰æ›ç‚ºç±³ (Scale: 1px = scaleRatio meters)
        const distM = totalDistPx * scaleRatio;
        const dispM = dispPx * scaleRatio;
        
        // æ›´æ–° UI
        ui.dist.innerText = distM.toFixed(1) + " m";
        ui.disp.innerText = dispM.toFixed(1) + " m";
        ui.speed.innerText = (distM / 5.0).toFixed(2) + " m/s";
        ui.vel.innerText = (dispM / 5.0).toFixed(2) + " m/s";
    }

    function loop() {
        if (!isAnimating) return;

        const elapsed = Date.now() - startTime;
        let progress = elapsed / DURATION;

        if (progress >= 1) {
            progress = 1;
            isAnimating = false;
            ui.hint.innerText = "æ¨¡æ“¬å®Œæˆã€‚é»æ“Šã€Œé‡ç½®ã€å†ä¾†ä¸€æ¬¡ã€‚";
            ui.btnStart.disabled = false; // å…è¨±å†æ¬¡æ’­æ”¾
        } else {
            requestAnimationFrame(loop);
        }

        drawFrame(progress);
    }

    function drawFrame(progress) {
        drawStatic(); // é‡ç¹ªèƒŒæ™¯å’Œç·šæ¢

        // --- 1. è¨ˆç®—è—è‰²è·‘è€…ä½ç½® & æ–¹å‘ ---
        let totalLen = 0;
        let segLens = [];
        for(let i=0; i<points.length-1; i++) {
            let len = Math.hypot(points[i+1].x - points[i].x, points[i+1].y - points[i].y);
            segLens.push(len);
            totalLen += len;
        }

        let currentDist = totalLen * progress;
        let covered = 0;
        let bluePos = { x: points[0].x, y: points[0].y };
        let blueDx = 1; // é è¨­é¢å‘å³

        for(let i=0; i<segLens.length; i++) {
            if (currentDist <= covered + segLens[i]) {
                // åœ¨é€™ä¸€æ®µç·šä¸Š
                let segProgress = (currentDist - covered) / segLens[i];
                bluePos.x = points[i].x + (points[i+1].x - points[i].x) * segProgress;
                bluePos.y = points[i].y + (points[i+1].y - points[i].y) * segProgress;
                
                // è¨ˆç®—é€™ä¸€æ®µçš„æ–¹å‘
                blueDx = points[i+1].x - points[i].x;
                break;
            }
            covered += segLens[i];
            if(i === segLens.length - 1) {
                bluePos = points[points.length-1];
                blueDx = points[i].x - points[i-1].x; // ä¿æŒæœ€å¾Œä¸€æ®µçš„æ–¹å‘
            }
        }

        // --- 2. è¨ˆç®—ç´…è‰²è·‘è€…ä½ç½® & æ–¹å‘ ---
        let redPos = {
            x: points[0].x + (points[points.length-1].x - points[0].x) * progress,
            y: points[0].y + (points[points.length-1].y - points[0].y) * progress
        };
        let redDx = points[points.length-1].x - points[0].x;

        // --- 3. ç¹ªè£½å…ƒç´  ---
        
        // ç•«ä½ç§»è™›ç·š (ç´…è‰²)
        ctx.beginPath();
        ctx.setLineDash([8, 8]);
        ctx.strokeStyle = 'rgba(192, 57, 43, 0.4)';
        ctx.lineWidth = 2;
        ctx.moveTo(points[0].x, points[0].y);
        ctx.lineTo(points[points.length-1].x, points[points.length-1].y);
        ctx.stroke();
        ctx.setLineDash([]); 

        // ç•«è·‘è€…
        drawMan(ctx, redPos.x, redPos.y, '#c0392b', redDx, 's'); // ç´…è‰² (ä½ç§»)
        drawMan(ctx, bluePos.x, bluePos.y, '#2980b9', blueDx, 'd'); // è—è‰² (è·¯ç¨‹)
    }

    // ç•«ç«æŸ´äººå‡½å¼
    function drawMan(ctx, x, y, color, dx, label) {
        ctx.save();
        ctx.translate(x, y);
        
        // æ ¹æ“šç§»å‹•æ–¹å‘ç¿»è½‰ (dx < 0 å‰‡æ°´å¹³ç¿»è½‰)
        if (dx < 0) ctx.scale(-1, 1);

        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // 1. é ­éƒ¨ (Head)
        ctx.beginPath();
        ctx.arc(0, -12, 4, 0, Math.PI*2);
        ctx.fill();

        // 2. èº«é«” (Body)
        ctx.beginPath();
        ctx.moveTo(0, -8);
        ctx.lineTo(0, 5);
        ctx.stroke();

        // 3. è…¿éƒ¨ (Legs) - è·‘æ­¥å§¿å‹¢
        ctx.beginPath();
        ctx.moveTo(0, 5); 
        ctx.lineTo(-6, 14); // å¾Œè…¿
        ctx.moveTo(0, 5);
        ctx.lineTo(6, 12);  // å‰è…¿
        ctx.stroke();

        // 4. æ‰‹è‡‚ (Arms) - æ“ºå‹•å§¿å‹¢
        ctx.beginPath();
        ctx.moveTo(0, -5);
        ctx.lineTo(-5, 0); // å¾Œæ‰‹
        ctx.moveTo(0, -5);
        ctx.lineTo(5, -6); // å‰æ‰‹
        ctx.stroke();

        ctx.restore();

        // 5. æ¨™ç±¤ (ä¿æŒæ­£å‘ï¼Œä¸éš¨äººç¿»è½‰)
        ctx.fillStyle = color;
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(label, x, y - 22);
    }

    // --- åŠŸèƒ½å‡½æ•¸ ---
    function resetSim() {
        points = [];
        isAnimating = false;
        ghostPoint = null;
        
        ui.hint.innerText = "è«‹åœ¨ç•«å¸ƒä¸Šé»æ“Šã€Œèµ·å§‹é»ã€";
        ui.btnStart.disabled = true; // é‡ç½®æ™‚ç¦ç”¨
        ui.dist.innerText = "0.0 m";
        ui.disp.innerText = "0.0 m";
        ui.speed.innerText = "0.00 m/s";
        ui.vel.innerText = "0.00 m/s";
        
        resize(); // é‡ç•«ä¹¾æ·¨çš„ç•«å¸ƒ
    }

    function toggleModal(show) {
        const modal = document.getElementById('conceptModal');
        if(show) modal.classList.add('active');
        else modal.classList.remove('active');
    }
</script>

</body>
</html>
