<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ç†æ¨¡æ“¬ï¼šè‡ªç”±è½é«”èˆ‡ç©ºæ°£é˜»åŠ›æ¢ç©¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- MathJax for LaTeX rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .canvas-container { position: relative; width: 100%; height: 100%; }
        canvas { display: block; }
        .modal { transition: opacity 0.3s ease; backdrop-filter: blur(4px); }
        
        /* Math Font Class */
        .math-font {
            font-family: 'Noto Serif', 'Times New Roman', serif;
        }
        
        /* Modern Slim Range Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px; width: 14px; 
            border-radius: 50%; 
            background: #475569; 
            cursor: pointer; 
            margin-top: -5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; 
            cursor: pointer; 
            background: #e2e8f0; 
            border-radius: 2px;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    </style>
</head>
<body class="text-slate-700">

    <!-- Pop-up Screen -->
    <div id="introModal" class="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 modal opacity-0 pointer-events-none">
        <div class="bg-white/95 rounded-2xl p-8 max-w-2xl w-full mx-4 shadow-2xl relative border-t-4 border-blue-500">
            <button onclick="closeModal()" class="absolute top-5 right-5 text-slate-400 hover:text-red-500 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center">
                <span class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-2 rounded-lg mr-3 shadow-md"><i class="fas fa-atom"></i></span>
                èª²å‰å°è®€ï¼šè‡ªç”±è½é«”
            </h2>
            
            <div class="space-y-5 text-base leading-relaxed text-slate-600">
                <p>å„ä½åŒå­¸ï¼Œæ­¡è¿ä¾†åˆ°<b>ç‰©ç†å¯¦é©—å®¤</b>ã€‚ä»Šå¤©æˆ‘å€‘æ¢è¨ç‰©é«”å¦‚ä½•ä¸‹è½ã€‚</p>
                <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 text-center shadow-inner">
                    <div class="text-xs text-indigo-400 mb-2 uppercase tracking-wider font-bold">é—œéµå…¬å¼</div>
                    <div class="font-mono text-xl text-indigo-900">$$ s = ut + \frac{1}{2}at^2 $$</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 shadow-sm">
                        <h3 class="font-bold text-orange-800 mb-2"><i class="fas fa-rocket mr-1"></i> çœŸç©º (ç„¡é˜»åŠ›)</h3>
                        <p class="text-sm">åˆåŠ› \( F = mg \)<br>åŠ é€Ÿåº¦ \( a = g \)<br>çµæœï¼š<b>æ‰€æœ‰ç‰©é«”åŒæ™‚è½åœ°</b></p>
                    </div>
                    <div class="bg-teal-50 p-4 rounded-xl border border-teal-100 shadow-sm">
                        <h3 class="font-bold text-teal-800 mb-2"><i class="fas fa-wind mr-1"></i> ç©ºæ°£ (æœ‰é˜»åŠ›)</h3>
                        <p class="text-sm">åˆåŠ› \( F = mg - f_{drag} \)<br>çµæœï¼š<b>è³ªé‡èˆ‡å½¢ç‹€å½±éŸ¿è½åœ°æ™‚é–“</b></p>
                    </div>
                </div>
            </div>

            <button onclick="closeModal()" class="mt-8 w-full bg-gradient-to-r from-slate-700 to-slate-900 hover:from-slate-800 hover:to-black text-white font-bold py-3 px-6 rounded-xl transition shadow-lg transform hover:scale-[1.01]">
                é–‹å§‹å¯¦é©—
            </button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white/70 backdrop-blur-md px-6 py-3 flex justify-between items-center z-10 flex-shrink-0 border-b border-white/50 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold shadow-md">P</div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 tracking-tight">è‡ªç”±è½é«”æ¢ç©¶</h1>
                <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Physics Simulation Lab</p>
            </div>
        </div>
        <button onclick="openModal()" class="bg-white text-slate-600 hover:text-blue-600 border border-slate-200 hover:border-blue-300 transition text-sm font-medium flex items-center gap-2 px-4 py-1.5 rounded-full shadow-sm hover:shadow-md">
            <i class="fas fa-book-open text-xs"></i> <span class="hidden sm:inline">åŸç†èªªæ˜</span>
        </button>
    </header>

    <!-- Main Layout -->
    <div class="flex-grow p-4 overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-full">
            
            <!-- LEFT: Controls & Data -->
            <div class="lg:col-span-2 flex flex-col gap-3 overflow-y-auto custom-scroll pr-1">
                
                <!-- Object A Card -->
                <div class="bg-gradient-to-b from-white to-red-50 p-3 rounded-2xl shadow-sm border border-red-100 group hover:border-red-300 transition duration-300 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-red-100 rounded-bl-full -mr-8 -mt-8 opacity-50"></div>
                    
                    <div class="flex justify-between items-center mb-2 relative z-10">
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-sm"></span>
                            <span class="text-xs font-bold text-red-800 uppercase tracking-wide">ç‰©é«” A</span>
                        </div>
                        <span class="text-xl transform group-hover:scale-110 transition filter drop-shadow-sm" id="icon-a-display">ğŸª¶</span>
                    </div>
                    
                    <select id="obj1-select" onchange="updatePresets('A')" class="w-full bg-white border border-red-100 rounded-lg p-2 text-xs font-medium text-slate-700 mb-3 focus:ring-2 focus:ring-red-200 focus:outline-none cursor-pointer shadow-sm relative z-10">
                        <option value="feather" data-mass="0.1" data-drag="0.8" data-icon="ğŸª¶">ğŸª¶ ç¾½æ¯› (0.1kg)</option>
                        <option value="tennis" data-mass="0.5" data-drag="0.3" data-icon="ğŸ¾" selected>ğŸ¾ ç¶²çƒ (0.5kg)</option>
                        <option value="bowling" data-mass="5.0" data-drag="0.1" data-icon="ğŸ³">ğŸ³ ä¿é½¡çƒ (5kg)</option>
                        <option value="anvil" data-mass="50.0" data-drag="0.05" data-icon="ğŸ§±">ğŸ§± éµç § (50kg)</option>
                    </select>

                    <!-- Data Box -->
                    <div class="bg-white/80 rounded-lg p-2 mb-3 border border-red-200/60 shadow-inner relative z-10">
                        <div class="text-[9px] text-red-400 uppercase font-bold tracking-wider mb-1">å¯¦æ™‚æ•¸æ“š (Real-time Data)</div>
                        <div class="grid grid-cols-1 gap-1">
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">è³ªé‡ \(m\):</span>
                                <span class="font-mono font-bold text-slate-700"><span id="mass-a-display">0.5</span> <span class="text-[9px] text-slate-400">kg</span></span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">ä½ç§» \(s\):</span>
                                <span class="font-mono font-bold text-red-600"><span id="disp-a">0.00</span> <span class="text-[9px] text-slate-400">m</span></span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">é€Ÿåº¦ \(v\):</span>
                                <span class="font-mono font-bold text-red-600"><span id="vel-a">0.00</span> <span class="text-[9px] text-slate-400">m/s</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-red-200/50 mb-3 mx-1 relative z-10"></div>
                    
                    <div class="space-y-3 relative z-10">
                        <div>
                            <div class="flex justify-between text-[10px] text-red-900/60 mb-1 font-semibold">
                                <span>åˆé€Ÿ \(u\)</span>
                                <span class="font-mono text-red-700"><span id="val-u-a">0.0</span> <span class="text-[9px]">m/s</span></span>
                            </div>
                            <input type="range" id="slider-u-a" min="0" max="20" step="0.5" value="0" class="w-full accent-red-500" oninput="updateLabel('val-u-a', this.value)">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-red-900/60 mb-1 font-semibold">
                                <span>é˜»åŠ› \(C_d\)</span>
                                <span class="font-mono text-red-700" id="val-drag-a">0.30</span>
                            </div>
                            <input type="range" id="slider-drag-a" min="0" max="1.0" step="0.01" value="0.3" class="w-full accent-red-500" oninput="updateLabel('val-drag-a', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Object B Card -->
                <div class="bg-gradient-to-b from-white to-blue-50 p-3 rounded-2xl shadow-sm border border-blue-100 group hover:border-blue-300 transition duration-300 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-blue-100 rounded-bl-full -mr-8 -mt-8 opacity-50"></div>
                    
                    <div class="flex justify-between items-center mb-2 relative z-10">
                        <div class="flex items-center gap-2">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-500 shadow-sm"></span>
                            <span class="text-xs font-bold text-blue-800 uppercase tracking-wide">ç‰©é«” B</span>
                        </div>
                        <span class="text-xl transform group-hover:scale-110 transition filter drop-shadow-sm" id="icon-b-display">ğŸ³</span>
                    </div>

                    <select id="obj2-select" onchange="updatePresets('B')" class="w-full bg-white border border-blue-100 rounded-lg p-2 text-xs font-medium text-slate-700 mb-3 focus:ring-2 focus:ring-blue-200 focus:outline-none cursor-pointer shadow-sm relative z-10">
                        <option value="feather" data-mass="0.1" data-drag="0.8" data-icon="ğŸª¶">ğŸª¶ ç¾½æ¯› (0.1kg)</option>
                        <option value="tennis" data-mass="0.5" data-drag="0.3" data-icon="ğŸ¾">ğŸ¾ ç¶²çƒ (0.5kg)</option>
                        <option value="bowling" data-mass="5.0" data-drag="0.1" data-icon="ğŸ³" selected>ğŸ³ ä¿é½¡çƒ (5kg)</option>
                        <option value="anvil" data-mass="50.0" data-drag="0.05" data-icon="ğŸ§±">ğŸ§± éµç § (50kg)</option>
                    </select>

                    <div class="bg-white/80 rounded-lg p-2 mb-3 border border-blue-200/60 shadow-inner relative z-10">
                        <div class="text-[9px] text-blue-400 uppercase font-bold tracking-wider mb-1">å¯¦æ™‚æ•¸æ“š (Real-time Data)</div>
                        <div class="grid grid-cols-1 gap-1">
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">è³ªé‡ \(m\):</span>
                                <span class="font-mono font-bold text-slate-700"><span id="mass-b-display">5.0</span> <span class="text-[9px] text-slate-400">kg</span></span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">ä½ç§» \(s\):</span>
                                <span class="font-mono font-bold text-blue-600"><span id="disp-b">0.00</span> <span class="text-[9px] text-slate-400">m</span></span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-slate-500">é€Ÿåº¦ \(v\):</span>
                                <span class="font-mono font-bold text-blue-600"><span id="vel-b">0.00</span> <span class="text-[9px] text-slate-400">m/s</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-blue-200/50 mb-3 mx-1 relative z-10"></div>

                    <div class="space-y-3 relative z-10">
                        <div>
                            <div class="flex justify-between text-[10px] text-blue-900/60 mb-1 font-semibold">
                                <span>åˆé€Ÿ \(u\)</span>
                                <span class="font-mono text-blue-700"><span id="val-u-b">0.0</span> <span class="text-[9px]">m/s</span></span>
                            </div>
                            <input type="range" id="slider-u-b" min="0" max="20" step="0.5" value="0" class="w-full accent-blue-500" oninput="updateLabel('val-u-b', this.value)">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] text-blue-900/60 mb-1 font-semibold">
                                <span>é˜»åŠ› \(C_d\)</span>
                                <span class="font-mono text-blue-700" id="val-drag-b">0.10</span>
                            </div>
                            <input type="range" id="slider-drag-b" min="0" max="1.0" step="0.01" value="0.1" class="w-full accent-blue-500" oninput="updateLabel('val-drag-b', this.value)">
                        </div>
                    </div>
                </div>

                <!-- Global Actions -->
                <div class="mt-auto space-y-3">
                    <label class="flex items-center gap-3 p-3 bg-white/80 rounded-xl border border-white shadow-sm cursor-pointer hover:bg-white transition backdrop-blur-sm">
                        <div class="relative">
                            <input type="checkbox" id="air-toggle" class="sr-only peer" onclick="updateEquationDisplay()">
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500 shadow-inner"></div>
                        </div>
                        <span class="text-xs font-bold text-slate-600"><i class="fas fa-wind mr-1 text-slate-400"></i> ç©ºæ°£é˜»åŠ›</span>
                    </label>

                    <div class="flex gap-2">
                        <button id="start-btn" onclick="startSimulation()" class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white font-bold py-3 px-2 rounded-xl text-xs shadow-md transition flex justify-center items-center gap-2 transform active:scale-95">
                            <i class="fas fa-play"></i> é–‹å§‹
                        </button>
                        <button onclick="resetSimulation()" class="bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 font-bold py-3 px-4 rounded-xl text-xs shadow-sm transition transform active:scale-95">
                            <i class="fas fa-redo text-slate-400"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- CENTER: Immersive Simulation -->
            <div class="lg:col-span-4 flex flex-col bg-white rounded-3xl shadow-lg border border-white/60 overflow-hidden relative group ring-1 ring-black/5">
                <div class="absolute top-4 left-4 right-4 flex justify-between items-start z-10">
                    <div class="bg-white/80 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-bold text-slate-500 shadow-sm border border-white">
                        <i class="fas fa-ruler-vertical mr-1"></i> 100m
                    </div>
                    <div class="bg-slate-800/90 backdrop-blur text-white px-4 py-1.5 rounded-full font-mono text-sm shadow-md border border-slate-700">
                        t = <span id="time-display" class="text-emerald-400">0.00</span>s
                    </div>
                </div>

                <div class="canvas-container flex-grow relative bg-gradient-to-b from-sky-50 via-white to-slate-100" id="anim-container">
                    <canvas id="simCanvas" class="w-full h-full"></canvas>
                    <div class="absolute right-0 top-0 h-full w-px bg-slate-200"></div>
                    <div class="absolute left-4 top-0 h-full text-[9px] text-slate-400 flex flex-col justify-between py-8 select-none font-mono opacity-50">
                        <span>0m</span>
                        <span>25m</span>
                        <span>50m</span>
                        <span>75m</span>
                        <span>100m</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Clean Graphs -->
            <div class="lg:col-span-6 flex flex-col gap-4 h-full">
                
                <!-- v-t Graph -->
                <div class="bg-white/80 backdrop-blur-sm p-1 rounded-3xl shadow-sm border border-white/60 flex flex-col flex-1 min-h-0 relative ring-1 ring-black/5">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-400 to-red-400 rounded-t-3xl opacity-80"></div>
                    <div class="p-4 flex flex-col h-full">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center">
                            <span class="w-1.5 h-4 bg-orange-400 rounded-sm mr-2"></span> Velocity-Time
                        </h3>
                        <!-- BIG STYLISH EQUATION DISPLAY -->
                        <div id="vt-equations" class="mb-3 px-3 py-2 rounded-xl bg-orange-50/80 border border-orange-100 flex flex-col gap-1 shadow-sm">
                            <!-- JS Generated Math -->
                        </div>
                        <div class="relative flex-grow w-full min-h-0">
                            <canvas id="vtChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- s-t Graph -->
                <div class="bg-white/80 backdrop-blur-sm p-1 rounded-3xl shadow-sm border border-white/60 flex flex-col flex-1 min-h-0 relative ring-1 ring-black/5">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-400 to-blue-400 rounded-t-3xl opacity-80"></div>
                    <div class="p-4 flex flex-col h-full">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center">
                            <span class="w-1.5 h-4 bg-teal-400 rounded-sm mr-2"></span> Displacement-Time
                        </h3>
                        <!-- BIG STYLISH EQUATION DISPLAY -->
                        <div id="st-equations" class="mb-3 px-3 py-2 rounded-xl bg-teal-50/80 border border-teal-100 flex flex-col gap-1 shadow-sm">
                            <!-- JS Generated Math -->
                        </div>
                        <div class="relative flex-grow w-full min-h-0">
                            <canvas id="stChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & State ---
        const g = 9.81; 
        const totalHeightMeters = 100;
        const timeStep = 0.02; 
        
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        let canvasHeight, canvasWidth, pixelsPerMeter;

        setTimeout(() => openModal(), 500);

        let isRunning = false;
        let time = 0;
        let animationId;
        
        let objA = { y: 0, v: 0, mass: 0.5, dragCoeff: 0.3, color: '#ef4444', icon: 'ğŸ¾', type: 'tennis', finished: false, finishTime: null };
        let objB = { y: 0, v: 0, mass: 5.0, dragCoeff: 0.1, color: '#3b82f6', icon: 'ğŸ³', type: 'bowling', finished: false, finishTime: null };
        
        const timeDisplay = document.getElementById('time-display');
        const dispAEl = document.getElementById('disp-a');
        const velAEl = document.getElementById('vel-a');
        const dispBEl = document.getElementById('disp-b');
        const velBEl = document.getElementById('vel-b');
        const airToggle = document.getElementById('air-toggle');
        
        // --- Chart Config ---
        Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
        Chart.defaults.color = '#64748b';
        Chart.defaults.borderColor = '#f1f5f9';

        const commonChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            elements: { 
                point: { radius: 0 },
                line: { tension: 0.4 } 
            },
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: {
                    type: 'linear',
                    beginAtZero: true,
                    ticks: { maxRotation: 0, autoSkip: true, font: { size: 10 } },
                    grid: { display: false } 
                },
                y: {
                    beginAtZero: true,
                    grid: { color: '#f1f5f9', borderDash: [4, 4] },
                    border: { display: false }, 
                    ticks: { font: { size: 10 } }
                }
            },
            plugins: {
                legend: { 
                    position: 'top', 
                    align: 'end', 
                    labels: { 
                        boxWidth: 8, 
                        usePointStyle: true, 
                        pointStyle: 'circle',
                        font: { size: 10, weight: 'bold' },
                        color: '#475569',
                        filter: function(item, chart) {
                            return item.text === 'A' || item.text === 'B';
                        }
                    } 
                }
            }
        };

        const vtCtx = document.getElementById('vtChart').getContext('2d');
        const vtChart = new Chart(vtCtx, {
            type: 'line',
            data: {
                datasets: [
                    { label: 'A', borderColor: '#ef4444', borderWidth: 2, data: [], fill: false },
                    { label: 'B', borderColor: '#3b82f6', borderWidth: 2, data: [], fill: false }
                ]
            },
            options: {
                ...commonChartOptions,
                plugins: { ...commonChartOptions.plugins, title: { display: false } }
            }
        });

        const stCtx = document.getElementById('stChart').getContext('2d');
        const stChart = new Chart(stCtx, {
            type: 'line',
            data: {
                datasets: [
                    { label: 'A', borderColor: '#ef4444', borderWidth: 2, data: [], fill: false },
                    { label: 'B', borderColor: '#3b82f6', borderWidth: 2, data: [], fill: false }
                ]
            },
            options: {
                ...commonChartOptions,
                plugins: { ...commonChartOptions.plugins, title: { display: false } }
            }
        });

        // --- Logic ---
        function updateLabel(id, value) {
            document.getElementById(id).innerText = parseFloat(value).toFixed(2);
            updateEquationDisplay(); 
        }

        // NEW: STYLISH BIG EQUATION DISPLAY LOGIC
        function updateEquationDisplay() {
            const uA = parseFloat(document.getElementById('slider-u-a').value).toFixed(2);
            const uB = parseFloat(document.getElementById('slider-u-b').value).toFixed(2);
            const gVal = 9.81;
            const isDrag = document.getElementById('air-toggle').checked;
            
            const warning = isDrag ? '<div class="text-slate-400 mt-2 italic text-[10px] text-center font-sans tracking-wide">(å…¬å¼åƒ…é©ç”¨æ–¼çœŸç©ºæˆ–åˆå§‹ç‹€æ…‹ / Formula valid for vacuum or initial state)</div>' : '';

            // v = u + at
            // Using "math-font" class for serif/latex look
            const vtHTML = `
                <div class="math-font text-base sm:text-lg flex justify-around items-center w-full">
                    <div class="text-red-600">
                        <span class="italic font-bold">v</span><sub class="text-xs">A</sub> = ${uA} + ${gVal}<span class="italic">t</span>
                    </div>
                    <div class="w-px h-6 bg-orange-200"></div>
                    <div class="text-blue-600">
                        <span class="italic font-bold">v</span><sub class="text-xs">B</sub> = ${uB} + ${gVal}<span class="italic">t</span>
                    </div>
                </div>
                ${warning}
            `;
            document.getElementById('vt-equations').innerHTML = vtHTML;

            // s = ut + 0.5at^2
            const stHTML = `
                <div class="math-font text-base sm:text-lg flex justify-around items-center w-full">
                    <div class="text-red-600">
                        <span class="italic font-bold">s</span><sub class="text-xs">A</sub> = ${uA == 0 ? '' : uA + '<span class="italic">t</span> + '} <span class="text-sm">Â½</span>(${gVal})<span class="italic">t</span>Â²
                    </div>
                    <div class="w-px h-6 bg-teal-200"></div>
                    <div class="text-blue-600">
                        <span class="italic font-bold">s</span><sub class="text-xs">B</sub> = ${uB == 0 ? '' : uB + '<span class="italic">t</span> + '} <span class="text-sm">Â½</span>(${gVal})<span class="italic">t</span>Â²
                    </div>
                </div>
                ${warning}
            `;
            document.getElementById('st-equations').innerHTML = stHTML;
        }

        function updatePresets(objId) {
            const select = document.getElementById(objId === 'A' ? 'obj1-select' : 'obj2-select');
            const option = select.options[select.selectedIndex];
            const dragSlider = document.getElementById(objId === 'A' ? 'slider-drag-a' : 'slider-drag-b');
            const dragLabel = document.getElementById(objId === 'A' ? 'val-drag-a' : 'val-drag-b');
            
            dragSlider.value = option.dataset.drag;
            dragLabel.innerText = parseFloat(option.dataset.drag).toFixed(2);

            const massDisplayId = objId === 'A' ? 'mass-a-display' : 'mass-b-display';
            document.getElementById(massDisplayId).innerText = option.dataset.mass;

            resetSimulation();
        }

        function getObjectParams(selectId, sliderUId, sliderDragId) {
            const select = document.getElementById(selectId);
            const option = select.options[select.selectedIndex];
            return {
                type: option.value, 
                mass: parseFloat(option.dataset.mass),
                dragCoeff: parseFloat(document.getElementById(sliderDragId).value),
                u: parseFloat(document.getElementById(sliderUId).value),
                icon: option.dataset.icon,
                name: option.text.split(' ')[0]
            };
        }

        function initSimulation() {
            const container = document.getElementById('anim-container');
            if (container) {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                canvasWidth = canvas.width;
                canvasHeight = canvas.height;
                pixelsPerMeter = (canvasHeight - 60) / totalHeightMeters; 
            }

            const paramsA = getObjectParams('obj1-select', 'slider-u-a', 'slider-drag-a');
            const paramsB = getObjectParams('obj2-select', 'slider-u-b', 'slider-drag-b');
            
            objA = { y: 0, v: paramsA.u, mass: paramsA.mass, dragCoeff: paramsA.dragCoeff, color: '#ef4444', icon: paramsA.icon, type: paramsA.type, finished: false, finishTime: null };
            objB = { y: 0, v: paramsB.u, mass: paramsB.mass, dragCoeff: paramsB.dragCoeff, color: '#3b82f6', icon: paramsB.icon, type: paramsB.type, finished: false, finishTime: null };

            document.getElementById('icon-a-display').innerText = paramsA.icon;
            document.getElementById('icon-b-display').innerText = paramsB.icon;
            
            document.getElementById('mass-a-display').innerText = paramsA.mass;
            document.getElementById('mass-b-display').innerText = paramsB.mass;

            time = 0;
            resetCharts();
            
            vtChart.options.scales.x.max = 6;
            vtChart.options.scales.y.max = 60; 
            stChart.options.scales.x.max = 6;
            stChart.options.scales.y.max = 100;
            vtChart.update();
            stChart.update();

            updateEquationDisplay(); 
            pushChartData(true);
            draw();
            updateStats();
        }

        function calculateAcceleration(obj) {
            if (airToggle.checked && obj.dragCoeff > 0) {
                const k = obj.dragCoeff * 0.5; 
                const dragForce = k * obj.v * obj.v; 
                const a = g - (dragForce / obj.mass);
                return a; 
            } else {
                return g;
            }
        }

        function predictSimulation() {
            let simA = { ...objA, y: 0, v: objA.v };
            let simB = { ...objB, y: 0, v: objB.v };
            let simTime = 0;
            const simStep = 0.05; 

            let maxV = 0;

            while ((simA.y < totalHeightMeters || simB.y < totalHeightMeters) && simTime < 120) { 
                if (simA.y < totalHeightMeters) {
                    let a = calculateAcceleration(simA);
                    simA.v += a * simStep;
                    simA.y += simA.v * simStep;
                    if(simA.v > maxV) maxV = simA.v;
                }
                if (simB.y < totalHeightMeters) {
                    let a = calculateAcceleration(simB);
                    simB.v += a * simStep;
                    simB.y += simB.v * simStep;
                    if(simB.v > maxV) maxV = simB.v;
                }
                simTime += simStep;
            }

            const timeLimit = Math.ceil(simTime * 1.1); 
            const velLimit = Math.ceil(maxV * 1.1);

            vtChart.options.scales.x.max = timeLimit;
            vtChart.options.scales.y.max = velLimit;
            
            stChart.options.scales.x.max = timeLimit;
            stChart.options.scales.y.max = 110; 

            vtChart.update();
            stChart.update();
        }

        function drawTerminalVelocityLines() {
            const maxTime = vtChart.scales.x.max;
            const maxY_VT = vtChart.scales.y.max;
            const maxY_ST = stChart.scales.y.max;

            if (airToggle.checked) {
                const calcVt = (obj) => {
                    if (obj.dragCoeff <= 0) return null;
                    const k = obj.dragCoeff * 0.5;
                    return Math.sqrt((obj.mass * g) / k);
                };

                const vtA = calcVt(objA);
                const vtB = calcVt(objB);

                if (vtA) {
                    vtChart.data.datasets.push({ label: 'Vt A', data: [{x: 0, y: vtA}, {x: maxTime, y: vtA}], borderColor: objA.color, borderDash: [5, 5], borderWidth: 1, pointRadius: 0, fill: false, order: 99 });
                }
                if (vtB) {
                    vtChart.data.datasets.push({ label: 'Vt B', data: [{x: 0, y: vtB}, {x: maxTime, y: vtB}], borderColor: objB.color, borderDash: [5, 5], borderWidth: 1, pointRadius: 0, fill: false, order: 99 });
                }
            }

            const addVerticalLine = (chart, timeVal, color, maxY) => {
                if (timeVal === null) return;
                chart.data.datasets.push({ label: 'End', data: [{x: timeVal, y: 0}, {x: timeVal, y: maxY}], borderColor: color, borderDash: [2, 4], borderWidth: 2, pointRadius: 0, fill: false, order: 98 });
            };

            addVerticalLine(vtChart, objA.finishTime, objA.color, maxY_VT);
            addVerticalLine(vtChart, objB.finishTime, objB.color, maxY_VT);
            addVerticalLine(stChart, objA.finishTime, objA.color, maxY_ST);
            addVerticalLine(stChart, objB.finishTime, objB.color, maxY_ST);

            vtChart.update();
            stChart.update();
        }

        function update() {
            if (!isRunning) return;
            let justFinishedA = false, justFinishedB = false;

            if (!objA.finished) {
                if (objA.y < totalHeightMeters) {
                    const aA = calculateAcceleration(objA);
                    objA.v += aA * timeStep;
                    objA.y += objA.v * timeStep;
                }
                if (objA.y >= totalHeightMeters) { 
                    objA.y = totalHeightMeters; 
                    objA.finished = true; 
                    objA.finishTime = time; 
                    justFinishedA = true; 
                }
            }

            if (!objB.finished) {
                if (objB.y < totalHeightMeters) {
                    const aB = calculateAcceleration(objB);
                    objB.v += aB * timeStep;
                    objB.y += objB.v * timeStep;
                } 
                if (objB.y >= totalHeightMeters) { 
                    objB.y = totalHeightMeters; 
                    objB.finished = true; 
                    objB.finishTime = time; 
                    justFinishedB = true; 
                }
            }

            time += timeStep;
            pushChartData(false, justFinishedA, justFinishedB);
            draw();
            updateStats();

            if (objA.finished && objB.finished) { stopSimulation(); return; }
            animationId = requestAnimationFrame(update);
        }

        function draw() {
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            
            ctx.fillStyle = '#64748b';
            ctx.fillRect(0, canvasHeight - 12, canvasWidth, 12);

            const mapY = (meters) => meters * pixelsPerMeter + 40; 

            ctx.strokeStyle = '#e2e8f0';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(canvasWidth / 2, 0);
            ctx.lineTo(canvasWidth / 2, canvasHeight);
            ctx.stroke();
            ctx.setLineDash([]);

            const drawObj = (obj, x) => {
                const yPos = mapY(obj.y);
                
                ctx.strokeStyle = obj.color + '60'; 
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, yPos);
                ctx.stroke();

                ctx.save();
                ctx.translate(x, yPos);

                if (obj.type === 'tennis') {
                    // NEW: Detailed Tennis Ball Drawing
                    const r = 14; // increased size slightly
                    
                    // Main body
                    ctx.beginPath(); 
                    ctx.arc(0, 0, r, 0, Math.PI * 2); 
                    ctx.fillStyle = '#ccff00'; // Fluorescent yellow
                    ctx.fill();
                    
                    // Shadow for 3D effect
                    const grad = ctx.createRadialGradient(-r/3, -r/3, r/4, 0, 0, r);
                    grad.addColorStop(0, 'rgba(255,255,255,0.3)');
                    grad.addColorStop(1, 'rgba(0,0,0,0.1)');
                    ctx.fillStyle = grad;
                    ctx.fill();

                    // Seam (The complex curve)
                    ctx.beginPath();
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2.5;
                    // Approximate the two-loop seam with bezier curves
                    ctx.moveTo(-r*0.6, -r*0.6);
                    ctx.bezierCurveTo(r*0.1, -r*0.1, r*0.8, -r*0.8, r*0.6, r*0.6);
                    ctx.moveTo(-r*0.6, r*0.6);
                    ctx.bezierCurveTo(r*0.1, r*0.1, r*0.8, r*0.8, r*0.6, -r*0.6);
                    ctx.stroke();
                    
                    // Outer rim
                    ctx.beginPath();
                    ctx.arc(0, 0, r, 0, Math.PI*2);
                    ctx.strokeStyle = '#aadd00';
                    ctx.lineWidth = 1;
                    ctx.stroke();

                } else if (obj.type === 'bowling') {
                    const r = 16;
                    ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI * 2); ctx.fillStyle = '#1a1a1a'; ctx.fill();
                    // Shine
                    ctx.beginPath(); ctx.arc(-r/3, -r/3, r/4, 0, Math.PI * 2); ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fill();
                    // Holes
                    ctx.fillStyle = '#000'; const holeR = 1.8;
                    ctx.beginPath(); ctx.arc(r/3, -r/4, holeR, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(r/2, 0, holeR, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(r/3, r/4, holeR, 0, Math.PI*2); ctx.fill();
                } else {
                    ctx.font = "24px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.shadowColor = "rgba(0,0,0,0.2)"; ctx.shadowBlur = 4;
                    ctx.fillText(obj.icon, 0, 0); ctx.shadowBlur = 0;
                }
                
                // Color ring for identification
                ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI * 2); ctx.strokeStyle = obj.color; ctx.lineWidth = 2; ctx.stroke();
                ctx.restore();
            };

            drawObj(objA, canvasWidth / 4);
            drawObj(objB, 3 * canvasWidth / 4);
        }

        function pushChartData(isInitial = false, justFinishedA = false, justFinishedB = false) {
            const tStr = time.toFixed(2);
            let valVA = objA.v, valSA = objA.y, valVB = objB.v, valSB = objB.y;

            if (objA.finished && !justFinishedA && !isInitial) { valVA = null; valSA = null; }
            if (objB.finished && !justFinishedB && !isInitial) { valVB = null; valSB = null; }

            vtChart.data.labels.push(tStr);
            vtChart.data.datasets[0].data.push(valVA);
            vtChart.data.datasets[1].data.push(valVB);

            stChart.data.labels.push(tStr);
            stChart.data.datasets[0].data.push(valSA);
            stChart.data.datasets[1].data.push(valSB);

            vtChart.update('none');
            stChart.update('none');
        }

        function resetCharts() {
            vtChart.data.datasets = vtChart.data.datasets.slice(0, 2);
            stChart.data.datasets = stChart.data.datasets.slice(0, 2);

            vtChart.data.labels = [];
            vtChart.data.datasets.forEach(d => d.data = []);
            vtChart.update();

            stChart.data.labels = [];
            stChart.data.datasets.forEach(d => d.data = []);
            stChart.update();
        }

        function updateStats() {
            timeDisplay.innerText = time.toFixed(2);
            dispAEl.innerText = objA.y.toFixed(2);
            velAEl.innerText = objA.v.toFixed(2);
            dispBEl.innerText = objB.y.toFixed(2);
            velBEl.innerText = objB.v.toFixed(2);
        }

        function startSimulation() {
            if (isRunning) return;
            predictSimulation();
            initSimulationState(); 
            isRunning = true;
            document.getElementById('start-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.getElementById('start-btn').classList.add('opacity-80', 'cursor-not-allowed');
            update();
        }
        
        function initSimulationState() {
            const paramsA = getObjectParams('obj1-select', 'slider-u-a', 'slider-drag-a');
            const paramsB = getObjectParams('obj2-select', 'slider-u-b', 'slider-drag-b');
            
            objA = { y: 0, v: paramsA.u, mass: paramsA.mass, dragCoeff: paramsA.dragCoeff, color: '#ef4444', icon: paramsA.icon, type: paramsA.type, finished: false, finishTime: null };
            objB = { y: 0, v: paramsB.u, mass: paramsB.mass, dragCoeff: paramsB.dragCoeff, color: '#3b82f6', icon: paramsB.icon, type: paramsB.type, finished: false, finishTime: null };
            
            time = 0;
            resetCharts();
            pushChartData(true);
        }

        function stopSimulation() {
            isRunning = false;
            cancelAnimationFrame(animationId);
            document.getElementById('start-btn').innerHTML = '<i class="fas fa-play"></i> é–‹å§‹';
            document.getElementById('start-btn').classList.remove('opacity-80', 'cursor-not-allowed');
            drawTerminalVelocityLines();
            vtChart.update();
            stChart.update();
        }

        function resetSimulation() {
            stopSimulation();
            initSimulation();
        }

        function closeModal() { document.getElementById('introModal').classList.add('opacity-0', 'pointer-events-none'); }
        function openModal() { document.getElementById('introModal').classList.remove('opacity-0', 'pointer-events-none'); }

        window.addEventListener('resize', () => { if(!isRunning) initSimulation(); });
        window.onload = initSimulation;

    </script>
</body>
</html>
