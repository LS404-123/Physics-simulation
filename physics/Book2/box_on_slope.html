<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ç†äº’å‹•æ•™å®¤ï¼šæ–œé¢åŠ›å­¸åˆ†æ (å«é‹å‹•æ¨¡æ“¬)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif:ital,wght@1,700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
            overflow-x: hidden;
        }

        /* æ•¸å­¸ç¬¦è™Ÿå°ˆç”¨æ¨£å¼ (æ¨¡æ“¬ LaTeX) */
        .math-font {
            font-family: 'Noto Serif', 'Times New Roman', serif;
            font-style: italic;
            font-weight: 700;
        }

        /* å…¬å¼å€å¡Šæ¨£å¼ */
        .formula-box {
            background-color: #f8fafc;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            margin: 0.5rem 0;
            font-family: 'Noto Serif', 'Times New Roman', serif;
            font-size: 1.1rem;
        }

        /* è‡ªå®šç¾© Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Canvas èƒŒæ™¯ */
        #canvas-container {
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-blue-600 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <div class="flex items-center space-x-3">
            <span class="text-2xl">ğŸ“</span>
            <h1 class="text-xl font-bold">é«˜ä¸­ç‰©ç†ï¼šæ–œé¢åŠ›å­¸ç³»çµ±åˆ†æ</h1>
        </div>
        <button onclick="showModal()" class="bg-white text-blue-600 px-4 py-2 rounded-full text-sm font-bold hover:bg-blue-50 transition shadow">
            ğŸ“– å¯¦é©—åŸç†èˆ‡æŒ‡å¼•
        </button>
    </header>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-grow flex flex-col lg:flex-row overflow-hidden">
        
        <!-- å·¦å´ï¼šæ§åˆ¶é¢æ¿ -->
        <aside class="w-full lg:w-1/3 bg-white p-6 shadow-lg z-10 flex flex-col overflow-y-auto border-r border-slate-200">
            
            <div class="mb-4 bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h2 class="font-bold text-lg text-blue-800 mb-2">è€å¸«çš„ç­†è¨˜ (Teacher's Note)</h2>
                <p class="text-sm text-slate-600 leading-relaxed">
                    è«‹èª¿æ•´æ–œé¢è§’åº¦ <span class="math-font">Î¸</span> èˆ‡å¤–åŠ› <span class="math-font">F</span>ã€‚
                    <br>
                    é»æ“Šã€Œé–‹å§‹æ¨¡æ“¬ã€è§€å¯Ÿé‹å‹•ã€‚æ³¨æ„ç•¶ <span class="math-font">v â‰  0</span> æ™‚ï¼Œæ‘©æ“¦åŠ› <span class="math-font">f</span> æ†èˆ‡é€Ÿåº¦æ–¹å‘ç›¸åã€‚
                </p>
            </div>

            <!-- æ–°å¢ï¼šåŠ›å­¸åˆ†ææŒ‰éˆ• -->
            <button onclick="showAnalysis()" class="w-full mb-6 bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 py-3 px-4 rounded-lg shadow-sm text-sm font-bold flex items-center justify-center space-x-2 transition group">
                <span class="text-xl">ğŸ“</span>
                <span class="group-hover:translate-x-1 transition-transform">æŸ¥çœ‹è©³ç´°åŠ›å­¸åˆ†æå…¬å¼</span>
            </button>

            <div class="space-y-6">
                <!-- æ§åˆ¶å€ -->
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-5">
                    <!-- æ–œé¢è§’åº¦ Slider -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="font-bold text-slate-700">æ–œé¢è§’åº¦ (<span class="math-font">Î¸</span>)</label>
                            <span id="angle-val" class="font-mono text-blue-600 font-bold">30Â°</span>
                        </div>
                        <input type="range" id="angle-slider" min="0" max="60" value="30" step="1">
                    </div>

                    <!-- å¤–åŠ› Slider -->
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="font-bold text-slate-700">æ²¿æ–œé¢å¤–åŠ› (<span class="math-font">F</span>)</label>
                            <span id="force-val" class="font-mono text-purple-600 font-bold">0 N</span>
                        </div>
                        <input type="range" id="force-slider" min="-100" max="100" value="0" step="5">
                    </div>
                </div>

                <!-- æ¨¡æ“¬æ§åˆ¶æŒ‰éˆ• -->
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-simulate" class="py-3 px-4 rounded-lg bg-green-600 text-white font-bold hover:bg-green-700 transition shadow flex justify-center items-center space-x-2">
                        <span>â–¶ é–‹å§‹æ¨¡æ“¬</span>
                    </button>
                    <button id="btn-reset" class="py-3 px-4 rounded-lg bg-slate-200 text-slate-700 font-bold hover:bg-slate-300 transition shadow flex justify-center items-center space-x-2">
                        <span>â¹ é‡ç½®ä½ç½®</span>
                    </button>
                </div>

                <div class="pt-2">
                    <button id="toggle-components" class="w-full py-3 px-4 rounded-lg border-2 border-indigo-500 text-indigo-600 font-bold hover:bg-indigo-50 transition flex items-center justify-center space-x-2">
                        <span>ğŸ”„ åˆ†è§£é‡åŠ›åˆ†é‡ (<span class="math-font">mg</span>)</span>
                    </button>
                </div>

                <!-- å¯¦æ™‚æ•¸æ“šé¡¯ç¤º -->
                <div class="bg-slate-100 p-4 rounded-lg font-mono text-sm space-y-2 border border-slate-200 shadow-inner">
                    <div class="flex justify-between">
                        <span>é‡åŠ› (<span class="math-font">mg</span>):</span>
                        <span>98.0 N</span>
                    </div>
                    <div class="flex justify-between text-green-700">
                        <span>æ­£å‘åŠ› (<span class="math-font">R</span>):</span>
                        <span id="calc-normal">--</span>
                    </div>
                    <div class="flex justify-between text-indigo-700">
                        <span>ä¸‹æ»‘åˆ†åŠ› (<span class="math-font">mg</span> sin<span class="math-font">Î¸</span>):</span>
                        <span id="calc-mgsin">--</span>
                    </div>
                    <div class="flex justify-between text-orange-600 font-bold">
                        <span>æ‘©æ“¦åŠ› (<span class="math-font">f</span>):</span>
                        <span id="calc-friction">--</span>
                    </div>
                    <div class="border-t border-slate-300 my-2"></div>
                    <div class="flex justify-between font-bold items-center" id="net-force-display">
                        <span>åˆåŠ› (<span class="math-font">F_net</span>):</span>
                        <span id="calc-net">--</span>
                    </div>
                    <div class="flex justify-between text-blue-600 font-bold items-center pt-2">
                        <span>é€Ÿåº¦ (<span class="math-font">v</span>):</span>
                        <span id="calc-velocity">0.0 m/s</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- å³å´ï¼šCanvas å€åŸŸ -->
        <section class="flex-grow bg-white relative flex flex-col" id="canvas-container">
            <canvas id="simCanvas" class="w-full h-full cursor-default"></canvas>
            
            <!-- æ¨™è¨»èªªæ˜ -->
            <div class="absolute bottom-4 right-4 bg-white/90 p-4 rounded-xl shadow-lg border border-slate-200 text-sm text-slate-700 pointer-events-none backdrop-blur-sm">
                <div class="font-bold mb-2 border-b border-slate-200 pb-1">åœ–ç¤ºèªªæ˜ (Legend)</div>
                <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                    <div class="flex items-center gap-2"><span class="w-3 h-3 bg-red-600 rounded-full inline-block"></span> <span class="math-font">mg</span> (é‡åŠ›)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 bg-green-600 rounded-full inline-block"></span> <span class="math-font">R</span> (æ­£å‘åŠ›)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 bg-purple-600 rounded-full inline-block"></span> <span class="math-font">F</span> (å¤–åŠ›)</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 bg-orange-500 rounded-full inline-block"></span> <span class="math-font">f</span> (æ‘©æ“¦åŠ›)</div>
                </div>
            </div>
        </section>
    </main>

    <!-- å½ˆå‡ºè¦–çª— 1: æ­¡è¿/æŒ‡å¼• (Modal) -->
    <div id="intro-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-8 transform transition-transform duration-300 scale-100 relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
            
            <h2 class="text-2xl font-bold text-blue-700 mb-4 border-b pb-2">ğŸ‘‹ å„ä½åŒå­¸å¥½ï¼</h2>
            
            <div class="space-y-4 text-slate-700">
                <p>æˆ‘æ˜¯ä½ å€‘çš„ç‰©ç†è€å¸«ã€‚é€™å€‹äº’å‹•ç¨‹å¼æ˜¯ç‚ºäº†å¹«åŠ©ä½ å€‘ç†è§£<b>æ–œé¢ä¸Šçš„å—åŠ›èˆ‡é‹å‹•</b>ã€‚</p>
                
                <div class="bg-blue-50 p-5 rounded-lg border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-800 mb-2">ğŸ’¡ æ“ä½œæŒ‡å¼•ï¼š</h3>
                    <ul class="list-disc list-inside space-y-2 ml-2 text-sm">
                        <li>èª¿æ•´ <span class="math-font">Î¸</span> (è§’åº¦) å’Œ <span class="math-font">F</span> (å¤–åŠ›) è§€å¯Ÿå—åŠ›åœ–è®ŠåŒ–ã€‚</li>
                        <li>é»æ“Š <span class="font-bold bg-green-100 text-green-800 px-2 py-0.5 rounded">â–¶ é–‹å§‹æ¨¡æ“¬</span> è®“ç‰©é«”æ ¹æ“šç‰›é “ç¬¬äºŒå®šå¾‹ (<span class="math-font">F = ma</span>) ç§»å‹•ã€‚</li>
                    </ul>
                </div>

                <div class="text-sm bg-yellow-50 p-3 rounded text-yellow-800 border border-yellow-200 flex items-start gap-2">
                    <span class="text-lg">âš ï¸</span>
                    <div>
                        <b>æ³¨æ„ï¼š</b> å¦‚æœåˆåŠ›ä¸è¶³ä»¥å…‹æœæœ€å¤§éœæ‘©æ“¦åŠ›ï¼Œé»æ“Šæ¨¡æ“¬å¾Œç‰©é«”ä»æœƒä¿æŒéœæ­¢ã€‚
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button onclick="closeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg transform hover:-translate-y-0.5 transition">
                    é–‹å§‹å¯¦é©— ğŸš€
                </button>
            </div>
        </div>
    </div>

    <!-- å½ˆå‡ºè¦–çª— 2: åŠ›å­¸åˆ†æè©³è§£ (Analysis Modal) -->
    <div id="analysis-modal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 p-8 transform transition-transform duration-300 scale-100 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeAnalysis()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-2xl font-bold">&times;</button>
            
            <div class="flex items-center space-x-3 mb-6 border-b pb-4">
                <span class="text-3xl">ğŸ“</span>
                <h2 class="text-2xl font-bold text-slate-800">åŠ›å­¸åˆ†æè©³è§£ (Mechanical Analysis)</h2>
            </div>
            
            <div class="space-y-6 text-slate-700">
                
                <!-- å‚ç›´æ–¹å‘ -->
                <section>
                    <h3 class="font-bold text-lg text-blue-700 mb-2 border-l-4 border-blue-500 pl-2">1. å‚ç›´æ–¼æ–œé¢æ–¹å‘ âŠ¥</h3>
                    <p class="mb-2">ç‰©é«”åœ¨æ­¤æ–¹å‘æ²’æœ‰ä½ç§»ï¼Œå› æ­¤è™•æ–¼åŠ›å¹³è¡¡ç‹€æ…‹ã€‚å—åŠ›åŒ…æ‹¬æ­£å‘åŠ› <span class="math-font">R</span> èˆ‡é‡åŠ›çš„å‚ç›´åˆ†é‡ã€‚</p>
                    <div class="formula-box">
                        <span class="math-font">R</span> - <span class="math-font">mg</span> cos<span class="math-font">Î¸</span> = 0
                        <br>
                        <span class="text-blue-600 font-bold">âˆ´ <span class="math-font">R</span> = <span class="math-font">mg</span> cos<span class="math-font">Î¸</span></span>
                    </div>
                </section>

                <!-- å¹³è¡Œæ–¹å‘ -->
                <section>
                    <h3 class="font-bold text-lg text-green-700 mb-2 border-l-4 border-green-500 pl-2">2. æ²¿æ–œé¢æ–¹å‘ âˆ¥</h3>
                    <p class="mb-2">é€™æ˜¯ç‰©é«”é‹å‹•çš„æ–¹å‘ã€‚æ ¹æ“šç‰›é “ç¬¬äºŒå®šå¾‹ï¼ŒåˆåŠ›æ±ºå®šåŠ é€Ÿåº¦ã€‚</p>
                    <p class="text-sm text-slate-500 mb-2">*(å¦‚æœç‰©é«”å—åˆ°çš„åŠ› F æ²¿æ–œé¢å‘ä¸Š,å¹¶ä¸”å‡è¨­å‘ä¸Šç‚ºæ­£ +)*</p>
                    <div class="formula-box">
                        <span class="math-font">F</span> - <span class="math-font">mg</span> sin<span class="math-font">Î¸</span> - <span class="math-font">f</span> = <span class="math-font">ma</span>
                    </div>
                    <ul class="list-disc list-inside ml-4 mt-2 text-sm space-y-1">
                        <li><span class="math-font font-bold text-purple-600">F</span> : æ–½åŠ çš„å¤–åŠ› (æ¨åŠ›æˆ–æ‹‰åŠ›)</li>
                        <li><span class="math-font font-bold text-red-600">mg sinÎ¸</span> : é‡åŠ›çš„ä¸‹æ»‘åˆ†é‡ (æ°¸é å‘ä¸‹)</li>
                        <li><span class="math-font font-bold text-orange-600">f</span> : æ‘©æ“¦åŠ› (å‹•æ‘©æ“¦ æˆ– éœæ‘©æ“¦)</li>
                    </ul>
                </section>

                <!-- æ‘©æ“¦åŠ›è¨è«– -->
                <section>
                    <h3 class="font-bold text-lg text-orange-700 mb-2 border-l-4 border-orange-500 pl-2">3. é—œæ–¼æ‘©æ“¦åŠ› (Friction)</h3>
                    <div class="bg-orange-50 p-4 rounded-lg text-sm border border-orange-200">
                        <p class="mb-2"><b>æ‘©æ“¦åŠ›æ–¹å‘ï¼š</b> æ°¸é èˆ‡ç‰©é«”çš„ç›¸å°é‹å‹•æ–¹å‘ï¼ˆæˆ–é‹å‹•è¶¨å‹¢ï¼‰ç›¸åã€‚</p>
                    </div>
                </section>

            </div>

            <div class="mt-8 flex justify-center">
                <button onclick="closeAnalysis()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-8 py-2 rounded-full font-bold transition">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ç‰©ç†åƒæ•¸è¨­å®š
         */
        const PHYSICS = {
            g: 9.8,
            mass: 10,       // kg
            mu: 0.3,        // æ‘©æ“¦ä¿‚æ•¸ (éœ=å‹•)
            timeStep: 1/60  // ç§’
        };
        
        // ç³»çµ±ç‹€æ…‹
        let state = {
            angle: 30,           // åº¦
            appliedForce: 0,     // N
            showComponents: false,
            width: 0,
            height: 0,
            
            // æ¨¡æ“¬ç›¸é—œ
            isSimulating: false,
            simX: 0,             // ä½ç§» (æ²¿æ–œé¢ï¼Œç±³)ï¼Œ0ç‚ºåˆå§‹ä¸­å¿ƒ
            velocity: 0,         // m/s
            
            // UI ç·©å­˜ (ç”¨æ–¼é¡¯ç¤º)
            lastFriction: 0,
            lastNetForce: 0,
            motionState: 'static' // 'static', 'moving_up', 'moving_down'
        };

        // DOM å…ƒç´ å¼•ç”¨
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const els = {
            angleSlider: document.getElementById('angle-slider'),
            forceSlider: document.getElementById('force-slider'),
            btnComponents: document.getElementById('toggle-components'),
            btnSimulate: document.getElementById('btn-simulate'),
            btnReset: document.getElementById('btn-reset'),
            angleVal: document.getElementById('angle-val'),
            forceVal: document.getElementById('force-val'),
            modal: document.getElementById('intro-modal'),
            analysisModal: document.getElementById('analysis-modal'), // æ–°å¢å¼•ç”¨
            // æ•¸å€¼é¡¯ç¤º
            uiNormal: document.getElementById('calc-normal'),
            uiMgSin: document.getElementById('calc-mgsin'),
            uiFriction: document.getElementById('calc-friction'),
            uiNet: document.getElementById('calc-net'),
            uiVel: document.getElementById('calc-velocity'),
            netDisplay: document.getElementById('net-force-display')
        };

        // å‹•ç•«å¾ªç’° ID
        let animationFrameId;

        /**
         * åˆå§‹åŒ–
         */
        function init() {
            window.addEventListener('resize', resizeCanvas);
            
            // Slider äº‹ä»¶
            els.angleSlider.addEventListener('input', (e) => {
                state.angle = parseInt(e.target.value);
                els.angleVal.textContent = state.angle + 'Â°';
                if (!state.isSimulating) draw(); 
            });

            els.forceSlider.addEventListener('input', (e) => {
                state.appliedForce = parseInt(e.target.value);
                els.forceVal.textContent = (state.appliedForce > 0 ? '+' : '') + state.appliedForce + ' N';
                if (!state.isSimulating) draw();
            });

            // æŒ‰éˆ•äº‹ä»¶
            els.btnComponents.addEventListener('click', () => {
                state.showComponents = !state.showComponents;
                els.btnComponents.classList.toggle('bg-indigo-100');
                els.btnComponents.classList.toggle('border-indigo-700');
                draw();
            });

            els.btnSimulate.addEventListener('click', toggleSimulation);
            els.btnReset.addEventListener('click', resetSimulation);

            // å•Ÿå‹•
            resizeCanvas();
            animate(); // å•Ÿå‹•ä¸»å¾ªç’°
        }

        /**
         * æ¨¡æ“¬æ§åˆ¶
         */
        function toggleSimulation() {
            state.isSimulating = !state.isSimulating;
            
            if (state.isSimulating) {
                els.btnSimulate.innerHTML = '<span>â¸ æš«åœæ¨¡æ“¬</span>';
                els.btnSimulate.classList.replace('bg-green-600', 'bg-yellow-500');
                els.btnSimulate.classList.replace('hover:bg-green-700', 'hover:bg-yellow-600');
                // é–å®šè¼¸å…¥
                els.angleSlider.disabled = true;
                els.forceSlider.disabled = true;
                els.angleSlider.parentElement.classList.add('opacity-50');
                els.forceSlider.parentElement.classList.add('opacity-50');
            } else {
                els.btnSimulate.innerHTML = '<span>â–¶ ç¹¼çºŒæ¨¡æ“¬</span>';
                els.btnSimulate.classList.replace('bg-yellow-500', 'bg-green-600');
                els.btnSimulate.classList.replace('hover:bg-yellow-600', 'hover:bg-green-700');
                // è§£é–è¼¸å…¥
                els.angleSlider.disabled = false;
                els.forceSlider.disabled = false;
                els.angleSlider.parentElement.classList.remove('opacity-50');
                els.forceSlider.parentElement.classList.remove('opacity-50');
            }
        }

        function resetSimulation() {
            state.isSimulating = false;
            state.simX = 0;
            state.velocity = 0;
            
            // é‡ç½® UI æŒ‰éˆ•ç‹€æ…‹
            els.btnSimulate.innerHTML = '<span>â–¶ é–‹å§‹æ¨¡æ“¬</span>';
            els.btnSimulate.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            els.btnSimulate.classList.add('bg-green-600', 'hover:bg-green-700');
            
            els.angleSlider.disabled = false;
            els.forceSlider.disabled = false;
            els.angleSlider.parentElement.classList.remove('opacity-50');
            els.forceSlider.parentElement.classList.remove('opacity-50');
            
            draw();
        }

        /**
         * ç‰©ç†å¼•æ“æ›´æ–° (æ¯ä¸€å¹€)
         */
        function updatePhysics() {
            if (!state.isSimulating) {
                // å¦‚æœæ˜¯éœæ­¢ç‹€æ…‹ï¼Œä»ç„¶è¦è¨ˆç®—éœæ‘©æ“¦åŠ›ä»¥ä¾›é¡¯ç¤º
                calculateStaticForces();
                return;
            }

            const rad = state.angle * Math.PI / 180;
            const weight = PHYSICS.mass * PHYSICS.g;
            const normalForce = weight * Math.cos(rad);
            const downSlopeGravity = weight * Math.sin(rad); // æŒ‡å‘è² æ–¹å‘(å‡è¨­å·¦ä¸‹) æˆ– æ­£æ–¹å‘?
            // å®šç¾©ï¼šæ²¿æ–œé¢å‘ä¸Šç‚ºæ­£ X (+)ï¼Œå‘ä¸‹ç‚ºè²  X (-)
            // é‡åŠ›åˆ†é‡æ°¸é å‘ä¸‹ -> -mg sin(theta)
            const f_gravity_x = -downSlopeGravity; 
            
            // å¤–åŠ› F (sliderå€¼: æ­£ç‚ºä¸Š, è² ç‚ºä¸‹)
            const f_app = state.appliedForce;

            // æ‘©æ“¦åŠ›è¨ˆç®—
            let friction = 0;
            let netForce = 0;

            // å‹•æ‘©æ“¦ (Kinetic Friction)
            if (Math.abs(state.velocity) > 0.001) {
                // æœ‰é€Ÿåº¦æ™‚ï¼Œæ‘©æ“¦åŠ›èˆ‡é€Ÿåº¦æ–¹å‘ç›¸å
                const f_k = PHYSICS.mu * normalForce;
                friction = (state.velocity > 0) ? -f_k : f_k;
                netForce = f_app + f_gravity_x + friction;
            } 
            // éœæ‘©æ“¦åˆ¤æ–· (Static Friction) - é€Ÿåº¦æ¥µå°è¦–ç‚ºéœæ­¢
            else {
                state.velocity = 0; // å¼·åˆ¶æ­¸é›¶é˜²æ­¢å¾®å°æ¼‚ç§»
                const drivingForce = f_app + f_gravity_x; // æ²’æœ‰æ‘©æ“¦æ™‚çš„åˆåŠ›
                const maxStaticFriction = PHYSICS.mu * normalForce;

                if (Math.abs(drivingForce) <= maxStaticFriction) {
                    // éœæ­¢ï¼ŒåˆåŠ›ç‚º0
                    friction = -drivingForce;
                    netForce = 0;
                } else {
                    // å…‹æœéœæ‘©æ“¦ï¼Œé–‹å§‹ç§»å‹•
                    // é€™è£¡ç°¡åŒ–ï¼šä¸€æ—¦å‹•èµ·ä¾†ï¼Œç«‹åˆ»è®Šå‹•æ‘©æ“¦ (æ–¹å‘èˆ‡ drivingForce ç›¸å)
                    const f_k = PHYSICS.mu * normalForce;
                    friction = (drivingForce > 0) ? -f_k : f_k;
                    netForce = drivingForce + friction;
                }
            }

            // æ›´æ–°é‹å‹•ç‹€æ…‹ (Euler Integration)
            const acceleration = netForce / PHYSICS.mass;
            state.velocity += acceleration * PHYSICS.timeStep;
            state.simX += state.velocity * PHYSICS.timeStep * 50; // *50 æ˜¯ç‚ºäº†è®“è¢å¹•ä¸Šçš„ç§»å‹•æ˜é¡¯ä¸€é» (åƒç´ /ç±³ çš„æ¯”ä¾‹)

            // é‚Šç•Œæª¢æŸ¥ (ç°¡å–®è™•ç†ï¼šç¢°åˆ°é‚Šç·£åœæ­¢)
            const limit = 350; // åƒç´ é™åˆ¶
            if (state.simX > limit) {
                state.simX = limit;
                state.velocity = 0;
                state.isSimulating = false; // åœæ­¢æ¨¡æ“¬
                toggleSimulation(); // æ›´æ–°UI
            } else if (state.simX < -limit) {
                state.simX = -limit;
                state.velocity = 0;
                state.isSimulating = false;
                toggleSimulation();
            }

            // æ›´æ–° UI é¡¯ç¤ºç”¨çš„ç·©å­˜è®Šæ•¸
            state.lastFriction = friction;
            state.lastNetForce = netForce;
        }

        /**
         * éœæ­¢ç‹€æ…‹ä¸‹çš„åŠ›è¨ˆç®— (åƒ…ä¾›é¡¯ç¤º)
         */
        function calculateStaticForces() {
            const rad = state.angle * Math.PI / 180;
            const weight = PHYSICS.mass * PHYSICS.g;
            const normalForce = weight * Math.cos(rad);
            const downSlopeGravity = weight * Math.sin(rad);
            const f_gravity_x = -downSlopeGravity;
            const f_app = state.appliedForce;
            
            const drivingForce = f_app + f_gravity_x;
            const maxStaticFriction = PHYSICS.mu * normalForce;

            if (Math.abs(drivingForce) <= maxStaticFriction) {
                state.lastFriction = -drivingForce;
                state.lastNetForce = 0;
            } else {
                const f_k = PHYSICS.mu * normalForce;
                state.lastFriction = (drivingForce > 0) ? -f_k : f_k;
                state.lastNetForce = drivingForce + state.lastFriction;
            }
        }

        /**
         * ä¸»å¾ªç’°
         */
        function animate() {
            updatePhysics();
            draw();
            updateUI();
            animationFrameId = requestAnimationFrame(animate);
        }

        /**
         * æ›´æ–°æ•¸å€¼é¢æ¿
         */
        function updateUI() {
            const rad = state.angle * Math.PI / 180;
            const weight = PHYSICS.mass * PHYSICS.g;
            const normal = weight * Math.cos(rad);
            const mgsin = weight * Math.sin(rad);

            els.uiNormal.textContent = normal.toFixed(1) + ' N';
            els.uiMgSin.textContent = mgsin.toFixed(1) + ' N';
            
            // æ‘©æ“¦åŠ›
            const f = state.lastFriction;
            let fText = Math.abs(f).toFixed(1) + ' N ';
            if (Math.abs(f) > 0.1) fText += (f > 0 ? '(å‘ä¸Š)' : '(å‘ä¸‹)');
            els.uiFriction.textContent = fText;

            // åˆåŠ›
            const net = state.lastNetForce;
            let netText = Math.abs(net).toFixed(1) + ' N';
            let netColor = 'text-slate-600';
            if (Math.abs(net) > 0.1) {
                netText += (net > 0 ? ' (åŠ é€Ÿå‘ä¸Š)' : ' (åŠ é€Ÿå‘ä¸‹)');
                netColor = net > 0 ? 'text-green-600' : 'text-red-600';
            } else {
                netText += ' (å¹³è¡¡/éœæ­¢)';
            }
            els.uiNet.textContent = netText;
            els.netDisplay.className = `flex justify-between font-bold items-center ${netColor}`;

            // é€Ÿåº¦
            // æŠŠåƒç´ é€Ÿåº¦è½‰å›ç‰©ç†é€Ÿåº¦é¡¯ç¤º (é™¤ä»¥æ¯”ä¾‹)
            // é€™è£¡é¡¯ç¤ºçœŸå¯¦ç‰©ç†é€Ÿåº¦æ¯”è¼ƒå¥½
            els.uiVel.textContent = state.velocity.toFixed(2) + ' m/s';
        }

        function resizeCanvas() {
            state.width = canvas.parentElement.clientWidth;
            state.height = canvas.parentElement.clientHeight;
            canvas.width = state.width;
            canvas.height = state.height;
            if(!state.isSimulating) draw();
        }

        // Modal Controls
        window.showModal = () => {
            els.modal.classList.remove('hidden');
            setTimeout(() => els.modal.classList.remove('opacity-0'), 10);
        };
        window.closeModal = () => {
            els.modal.classList.add('opacity-0');
            setTimeout(() => els.modal.classList.add('hidden'), 300);
        };
        // Analysis Modal Controls
        window.showAnalysis = () => {
            els.analysisModal.classList.remove('hidden');
            setTimeout(() => els.analysisModal.classList.remove('opacity-0'), 10);
        };
        window.closeAnalysis = () => {
            els.analysisModal.classList.add('opacity-0');
            setTimeout(() => els.analysisModal.classList.add('hidden'), 300);
        };

        /**
         * ç¹ªåœ–å‡½æ•¸
         */
        function draw() {
            // æ¸…ç©º
            ctx.clearRect(0, 0, state.width, state.height);
            
            const rad = state.angle * Math.PI / 180;
            
            // è¨ˆç®—ç¹ªåœ–åŸé»èˆ‡æ–œé¢
            const originX = state.width * 0.1;
            const originY = state.height * 0.8;
            const rampLength = Math.min(state.width * 0.8, 800);
            
            const rampEndX = originX + rampLength * Math.cos(rad);
            const rampEndY = originY - rampLength * Math.sin(rad);

            // 1. ç•«æ–œé¢
            ctx.fillStyle = '#e2e8f0';
            ctx.strokeStyle = '#64748b';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(originX, originY);
            ctx.lineTo(rampEndX, rampEndY);
            ctx.lineTo(rampEndX, originY);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // è§’åº¦æ¨™è¨˜
            ctx.beginPath();
            ctx.arc(originX, originY, 40, 0, -rad, true);
            ctx.stroke();
            // ä½¿ç”¨ LaTeX é¢¨æ ¼å­—é«”
            ctx.font = 'italic bold 18px "Times New Roman", serif';
            ctx.fillStyle = '#475569';
            ctx.fillText('Î¸', originX + 50, originY - 10);

            // 2. ç•«ç‰©é«”
            const baseDist = rampLength * 0.5; // åˆå§‹åœ¨ä¸­é–“
            // simX æ˜¯åç§»é‡
            const currentDist = baseDist + (state.simX / Math.cos(0)); // ç°¡å–®æ˜ å°„
            
            // ç¢ºä¿ç‰©é«”ä¸æœƒç•«å‡ºæ–œé¢
            // é€™è£¡ simX å·²ç¶“é™åˆ¶äº†ï¼Œä½†è¦–è¦ºä¸Šå†åšä¸€æ¬¡ä¿è­·
            
            const blockX = originX + currentDist * Math.cos(rad) - 25 * Math.sin(rad);
            const blockY = originY - currentDist * Math.sin(rad) - 25 * Math.cos(rad);

            ctx.save();
            ctx.translate(blockX, blockY);
            ctx.rotate(-rad);

            const boxW = 80;
            const boxH = 50;

            // ç‰©é«”æœ¬é«”
            ctx.fillStyle = '#cbd5e1';
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 2;
            // ç¨å¾®åŠ é»é™°å½±å¢åŠ ç«‹é«”æ„Ÿ
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 10;
            ctx.fillRect(-boxW/2, -boxH/2, boxW, boxH);
            ctx.shadowBlur = 0;
            ctx.strokeRect(-boxW/2, -boxH/2, boxW, boxH);
            
            // è³ªå¿ƒ
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(0, 0, 3, 0, Math.PI*2);
            ctx.fill();
            // æ¨™ç¤ºè³ªé‡ m
            ctx.font = 'italic bold 16px "Times New Roman", serif';
            ctx.fillStyle = '#64748b';
            ctx.fillText('m', -boxW/2 + 5, -boxH/2 + 20);

            // 3. ç•«åŠ›å‘é‡ (åœ¨ç‰©é«”åæ¨™ç³»ä¸­)
            // æº–å‚™æ•¸æ“š
            const weight = PHYSICS.mass * PHYSICS.g;
            const normal = weight * Math.cos(rad);
            const f_app = state.appliedForce;
            const f_fric = state.lastFriction;
            
            const scale = 1.5; // å‘é‡é•·åº¦ç¸®æ”¾
            const lw = 3; // ç·šå¯¬

            // (A) æ­£å‘åŠ› R
            drawArrow(ctx, 0, -boxH/2, 0, -boxH/2 - normal * scale, '#16a34a', 'R', lw, 'right');

            // (B) å¤–åŠ› F
            if (Math.abs(f_app) > 1) {
                const startX = f_app > 0 ? boxW/2 : -boxW/2;
                const len = f_app * scale;
                drawArrow(ctx, startX, 0, startX + len, 0, '#9333ea', 'F', lw, 'top');
            }

            // (C) æ‘©æ“¦åŠ› f (åœ¨æ¥è§¸é¢)
            if (Math.abs(f_fric) > 0.5) {
                const contactY = boxH/2;
                // ç‚ºäº†ä¸è¢«æ–œé¢ç·šé®æ“‹ï¼Œç¨å¾®ä¸Šç§»ä¸€é»é»
                const drawY = contactY - 2; 
                const len = f_fric * scale;
                drawArrow(ctx, 0, drawY, len, drawY, '#f97316', 'f', lw, 'bottom');
            }

            // (D) é‡åŠ›
            ctx.restore(); // å›åˆ°ä¸–ç•Œåæ¨™
            ctx.save();
            ctx.translate(blockX, blockY); // åªç§»å‹•ä¸æ—‹è½‰

            if (state.showComponents) {
                ctx.rotate(-rad); // è½‰åˆ°æ–œé¢æ–¹å‘
                
                const mg_sin = weight * Math.sin(rad);
                const mg_cos = weight * Math.cos(rad);
                
                const l_sin = mg_sin * scale;
                const l_cos = mg_cos * scale;

                ctx.strokeStyle = '#ef4444';
                ctx.setLineDash([4, 2]);
                ctx.lineWidth = 1;

                // mg cos theta
                drawArrow(ctx, 0, 0, 0, l_cos, '#ef4444', '', 1, 'none', true);
                // mg sin theta (å‘ä¸‹å¡)
                drawArrow(ctx, 0, 0, -l_sin, 0, '#ef4444', '', 1, 'none', true);

                // çŸ©å½¢
                ctx.beginPath();
                ctx.moveTo(0, l_cos);
                ctx.lineTo(-l_sin, l_cos);
                ctx.lineTo(-l_sin, 0);
                ctx.stroke();

                // æ¨™ç±¤
                ctx.setLineDash([]);
                ctx.fillStyle = '#b91c1c';
                ctx.font = 'italic bold 14px "Times New Roman", serif';
                ctx.textAlign = 'left';
                ctx.fillText('mg cosÎ¸', 5, l_cos/2);
                ctx.textAlign = 'center';
                ctx.fillText('mg sinÎ¸', -l_sin/2, 15);

                ctx.rotate(rad);
            }

            // ç¸½é‡åŠ› mg
            // å¦‚æœé¡¯ç¤ºåˆ†é‡ï¼Œå°‡åŸå§‹é‡åŠ›è®Šæ·¡ (é€æ˜åº¦ 0.3)
            const mgColor = state.showComponents ? 'rgba(220, 38, 38, 0.3)' : '#dc2626';
            drawArrow(ctx, 0, 0, 0, weight * scale, mgColor, 'mg', lw, 'left');

            ctx.restore();

            // [æ–°å¢] å¦‚æœé–‹å•Ÿåˆ†è§£æ¨¡å¼ï¼Œåœ¨å·¦ä¸‹è§’é¡¯ç¤ºå…¬å¼
            if (state.showComponents) {
                drawComponentFormulas(ctx, state.height);
            }
        }

        /**
         * [æ–°å¢] ç¹ªè£½é‡åŠ›åˆ†é‡å…¬å¼é¢æ¿
         */
        function drawComponentFormulas(ctx, canvasHeight) {
            ctx.save();
            
            const padding = 15;
            const boxWidth = 220;
            const boxHeight = 85;
            const x = 20;
            const y = canvasHeight - boxHeight - 20; // å®šä½åœ¨å·¦ä¸‹è§’

            // èƒŒæ™¯æ¡† (åœ“è§’çŸ©å½¢)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.strokeStyle = '#cbd5e1';
            ctx.lineWidth = 1;
            ctx.shadowColor = "rgba(0,0,0,0.1)";
            ctx.shadowBlur = 10;
            
            ctx.beginPath();
            // å…¼å®¹æ€§è™•ç†ï¼šå¦‚æœç€è¦½å™¨æ”¯æ´ roundRect å°±ç”¨ï¼Œå¦å‰‡ç”¨ rect
            if (ctx.roundRect) {
                ctx.roundRect(x, y, boxWidth, boxHeight, 12);
            } else {
                ctx.rect(x, y, boxWidth, boxHeight);
            }
            ctx.fill();
            ctx.stroke();
            ctx.shadowBlur = 0;

            // æ¨™é¡Œ
            ctx.font = 'bold 14px "Noto Sans TC", sans-serif';
            ctx.fillStyle = '#475569';
            ctx.textAlign = 'left';
            ctx.fillText("é‡åŠ›åˆ†é‡ (Components)ï¼š", x + padding, y + 25);

            // å…¬å¼é¡¯ç¤º
            ctx.font = 'italic bold 18px "Times New Roman", serif'; // LaTeX é¢¨æ ¼
            ctx.fillStyle = '#ef4444'; // èˆ‡åˆ†é‡ç®­é ­é¡è‰²ä¸€è‡´ (ç´…è‰²)
            
            // æ²¿æ–œé¢ (Parallel)
            // ä½¿ç”¨ F_parallel ç¬¦è™Ÿæˆ–ç›´æ¥å¯« mg sin
            ctx.fillText("Fâˆ¥ = mg sinÎ¸", x + padding, y + 50);
            
            // å‚ç›´æ–œé¢ (Perpendicular)
            ctx.fillText("FâŠ¥ = mg cosÎ¸", x + padding, y + 75);

            // ä¸­æ–‡è¨»è§£ (æ·¡è‰²)
            ctx.font = '12px "Noto Sans TC", sans-serif';
            ctx.fillStyle = '#94a3b8';
            ctx.fillText("(æ²¿æ–œé¢)", x + padding + 120, y + 50);
            ctx.fillText("(å‚ç›´æ–œé¢)", x + padding + 120, y + 75);

            ctx.restore();
        }

        /**
         * ç¹ªè£½ç®­é ­å·¥å…·
         */
        function drawArrow(ctx, x1, y1, x2, y2, color, label, width, labelPos = 'auto', isDashed = false) {
            const headlen = 10;
            const angle = Math.atan2(y2 - y1, x2 - x1);

            ctx.save();
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            ctx.lineWidth = width;
            if(isDashed) ctx.setLineDash([4, 2]);

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();

            ctx.setLineDash([]);
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();

            if (label && labelPos !== 'none') {
                ctx.font = 'italic bold 18px "Times New Roman", serif'; // LaTeX style
                
                let textX = x2;
                let textY = y2;
                const offset = 22;

                if (labelPos === 'auto') {
                    textX = x2 + offset * Math.cos(angle);
                    textY = y2 + offset * Math.sin(angle);
                } else if (labelPos === 'top') {
                    textY -= offset;
                } else if (labelPos === 'bottom') {
                    textY += offset;
                } else if (labelPos === 'left') {
                    textX -= offset;
                } else if (labelPos === 'right') {
                    textX += offset;
                }

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // æé‚Šç¢ºä¿å¯è®€æ€§
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.strokeText(label, textX, textY);
                ctx.fillText(label, textX, textY);
            }
            ctx.restore();
        }

        window.onload = init;
    </script>
</body>
</html>
